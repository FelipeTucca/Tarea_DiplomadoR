---
title: "Analisis exploratorio datos"
author: "Felipe Tucca"
date: '2022-05-10'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(stats)
library(MASS)
library(Rlab)
library(ggplot2)
library(psych)
library(kableExtra)
library(knitr)
library(DT)
library(pander)
library(tidyverse)
library(dplyr)
library(tidyr)

```

## ***Análisis exploratorio de datos***

# **Análisis preliminar de datos**

Ajuste previo de la información presente en la planilla "mortalidad" donde se realizó transformación de datos mediante as.factor, colapso de columnas con la función gather creándose nuevas columnas "causa" - "muertos" y filtrar valores cero. Finalmente se realizó un resumen de una nueva planilla llamada "Mortalidad1" para el trabajo posterior solicitado en la Pauta de trabajo.

```{r resumen preliminar, echo=TRUE}
summary(Mortalidad)
```

# *Transformación de datos mediante as.factor*

```{r transformación centro_id, echo=TRUE}
Mortalidad$centro_id <- as.factor(Mortalidad$centro_id)
```

```{r transformación año, echo=TRUE}
Mortalidad$año <- as.factor(Mortalidad$año)
```

```{r transformacion mes, echo=TRUE}
Mortalidad$mes <- as.factor(Mortalidad$mes)
```

```{r transformacion Semana, echo=TRUE}
Mortalidad$Semana <- as.factor(Mortalidad$Semana)
```

```{r resumen con factores modificados, echo=TRUE}
summary(Mortalidad)
```

# *Ordenar datos con gather() y filtrar valores cero de la base de datos*

```{r ordenar datos con gather, echo=TRUE}
Mortalidad1 <- gather(Mortalidad,"Causa", "Muertos", 7:8 ) %>% filter(Muertos > 0)
```

```{r resumen datos, echo=TRUE}
summary(Mortalidad1)
```
```{r transformación datos, echo=TRUE}
Mortalidad1$Causa <- as.factor(Mortalidad1$Causa)
```

# *Resumen*

```{r resumen datos finales, echo=TRUE}
summary(Mortalidad1)
```


## **Variación de la variable en estudio mediante histogramas**

## *Histograma 1*

```{r histograma 1 peces muertos, echo=TRUE}
ggplot(Mortalidad1, aes(Muertos)) + 
  geom_histogram(bins = 30, color = "red", fill = "blue")+ 
  labs(title="Histograma peces muertos", x="Muertos", y="Frecuencia") 
```

# *Transformación log con función mutate ()*

# *_Histograma peces muertos_*

```{r histograma 1 datos transformado log de peces muertos, echo=TRUE}
Mortalidad1 %>% mutate(log_Muertos= log(Muertos)) %>% ggplot(aes(log_Muertos)) + 
  geom_histogram(bins = 20, color = "red", fill = "blue")+ labs(title="Histograma peces muertos", x="Log Muertos", y="Frecuencia")
```

# *_Histograma biomasa muerta (toneladas)_*

```{r histograma 1 datos transformado log de biomasa muerta, echo=TRUE}
Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% mutate(log_biomasa= log(Biomasa_ton)) %>% ggplot(aes(log_biomasa)) + 
  geom_histogram(bins = 40, color = "yellow", fill = "green")+ labs(title="Histograma biomasa muerta (ton)", x="Log biomasa", y="Frecuencia")
```
## *Histograma 2*

```{r histograma 2, echo=TRUE}
ggplot(Mortalidad1, aes(Muertos))+geom_histogram(bins = 20, aes(color= Causa))+
  aes(position = "identity", bins =20, alpha = 0.3)
```

# *Transformación log con función mutate ()*

# *_Histograma log_Muertos y causa de mortalidad_*

Datos muestran que históricamente la mayor cantidad de peces muertos es por causa de bloom de algas.

```{r histograma 2 datos transformados log peces muertos y causa de mortalidad, echo=TRUE}
Mortalidad1 %>% mutate(log_Muertos= log(Muertos)) %>% ggplot(aes(log_Muertos))+ geom_histogram(bins = 30, aes(color= Causa))+
  aes(position = "identity", bins =20, alpha = 0.4)
```

# *_Histograma log_Biomasa muerta (toneladas) y causa de mortalidad_*

Existe una mayor biomasa muerta causada por bloom de algas que por la acción del oxígeno disuelto.

```{r histograma 2 datos transformados log biomasa muerta y causa de mortalidad, echo=TRUE}
Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% mutate(log_biomasa= log(Biomasa_ton)) %>% ggplot(aes(log_biomasa))+ geom_histogram(bins = 40, aes(color= Causa))+
  aes(position = "identity", bins =30, alpha = 0.4)

```

# **Tablas de frecuencia**

Para la base de datos se observa que la causa de mortalidad en salmon del Atlántico no esta balanceada, registrándose un mayor número de muertos por la variable oxígeno disuelto (864 muertos). En definitiva, existe mayor cantidad de observaciones por causa de muerte por OD que bloom de algas, lo que genera el desbalance de los datos.

```{r balance de datos Causa, echo=TRUE}
table(Mortalidad1$Causa)
```

Por otro lado, de acuerdo al registro de mortalidades por centro se observa que 4 centros registran históricamente un número mayor a 100 eventos por mortalidad provocadas por la acción de bloom de algas y disminución de oxígeno disuelto.

```{r balance de datos centro_id, echo=TRUE}
table(Mortalidad1$centro_id)
```

Para el barrio en estudio el mayor número de registros históricos de peces muertos se encuentran durante los años 2015, 2019 y 2021, siendo mayoritariamente reportados durante otoño (mes 3 - mes 4 - mes 5) y primavera (mes 10 - mes 11). 

```{r balance de datos tiempo, echo=TRUE}
table(Mortalidad1$año)
table(Mortalidad1$mes)
```

# **Relación entre variable cuantitativa y factores usando gráficas**

# *Boxplot biomasa muerta (toneladas) por causa de mortalidad*

La biomasa muerta para S. salar por causa de bloom algales ha sido mayor durante los años 2016, 2017 y 2021, mientras que para los años 2013, 2018, 2019 y 2020 la acción del oxígeno de disuelto (OD) reporta una mayor biomasa muerta para el barrio en estudio.

En esta gráfica se identifican datos faltantes para causa de muerte por bloom u OD (años 2011, 2012, 2018 y 2022), así como también valores atípicos principalmente para el registro de biomasa muerta a causa de bloom de algas (años 2013, 2015 y 2019). Mientras que para la causa de muerte por OD sobre la biomsa de S. salar registra valores atípicos para el año 2011, 2019 y 2021. 

```{r boxplot biomasa muerta por Causa, echo=TRUE}
Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% mutate(log_biomasa= log(Biomasa_ton)) %>% ggplot(aes(x= año, y= log_biomasa, fill= Causa)) + geom_boxplot() + labs( title = "Boxplot biomasa muerta por causa")
```

# *Correlación de variable y factores*

# *_Correlación biomasa muerta y correlativo de registros por centro entre 2011 al 2022_*

No existe un patrón claro que relacione el registro de causa de muerte en el tiempo sobre la biomasa de S.salar. Otras correlaciones fueron realizadas con la variable año y centro_id, pero tampoco hubo un patrón que relacione la biomasa muerta con el tiempo transcurrido ni el lugar. Se consideró como factor la causa de muerte en S. salar.

```{r Correlación biomasa y nro registro, echo=TRUE}
Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% mutate(log_biomasa= log(Biomasa_ton)) %>% ggplot(aes(x= Nro, y=log_biomasa, color=Causa))+ geom_point(size=1) + labs(x= "Nro registro", y= "Log biomasa (ton)")+ theme_gray() + labs( title = "Correlación registro - biomasa")
```

# *_Correlación peces muertos y peso entre los años 2011 a 2022_*

Aquellos salmones de mayor peso durante los 11 años de registros presentaron mayor nuemro de muertos por causa de bloom y oxígeno disuelto.

```{r}
Mortalidad1 %>% mutate(log_peso= log(Peso_g)) %>% mutate(log_muertos= log(Muertos)) %>% ggplot(aes(x= log_peso, y= log_muertos, color=Causa))+ geom_point(size=1) + labs(x= "Log Peso (g)", y= "Log muertos")+ theme_gray() + labs( title = "Correlación peso - muertos")
```



# **Resumen de datos mediante tablas y estadística descriptiva**

# *Estadística descriptiva*

La estadística descriptiva muestra que entre los años 2011 al 2022 la biomasa  muerta promedio para el barrio en estudio es de 7.6 toneladas (mediana equivalente a 0.44 ton), alcanzando un máximo de 1031 toneladas de salmones muertos. 

```{r estadísitica descriptiva biomasa muerta en registro histórico, echo=TRUE}
Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% summarize(n(), mean(Biomasa_ton), median(Biomasa_ton), max(Biomasa_ton))
```

Con respecto al número de muertos para este registro histórico se reporta un promedio de 3352 peces (mediana 155 muertos) entre los años 2011 al 2022, con un rango que va desde 1 a 463.152 salmones del Atlántico muertos.

```{r descripción variable número de muertos en registro histórico, echo=TRUE}
Mortalidad1 %>% summarize(n(), mean(Muertos), median(Muertos), min(Muertos), max(Muertos))
```

Finalmente, en ralación al peso del salmon del Atlántico muerto por la acción de bloom de algas y oxígeno disuelto en promedio salmones de 3 kg con una desviación estándar de 1.5 kg registraron mortalidades entre el 2011 a los primeros meses del años 2022.

```{r descripción variable peso, echo=TRUE}
Mortalidad1 %>% summarize(n(), mean(Peso_g), sd(Peso_g), median(Peso_g))
```

# *Tablas*

Tabla dinámica con toda la información utilizando la función datatable

```{r tabla de datos Mortalidad1, echo=TRUE}
DT::datatable(Mortalidad1, caption = "Mortalidad en Salmo salar entre los años 2011 al 2022 según registro de causa por bloom de algas y oxígeno disuelto")
```

Para resumir la biomasa muerta de S. salar por causa de bloom de algas y oxígeno disuelto dentro del barrio en estudio (periodo 2011 al 2022) se generó un nuevo objeto llamado *Mortalidad2*.

```{r resumen datos descriptivos para la muertalidad de S. salar por centro, echo=TRUE}
Mortalidad2 <- Mortalidad1 %>% mutate(Biomasa_ton= (Peso_g * Muertos)/1000000) %>% select(centro_id, Biomasa_ton) %>% group_by(centro_id) %>% summarize("N"= n(), "Promedio"= mean(Biomasa_ton), "DE"= sd(Biomasa_ton), "Mín"= min(Biomasa_ton), "Máx"= max(Biomasa_ton))
```

En base al resumen estadísitico descriptivo realizado en *Mortalidad2* se elaboró una nueva tabla con la función kbl(), la cual resume en una tabla el promedio, desviación estándar y rangos (min-máx) de la biomasa muerta (ton) a causa de los factores bloom y oxígeno disuelto.

```{r tabla resumen con kbl, echo=TRUE}
kbl(Mortalidad2, caption = "Tabla. Resumen de la biomasa muerta (toneladas) para la especie S. salar por cada centro de cultivo presente en el barrio entre los años 2011-2022") %>% kable_classic_2()
```




